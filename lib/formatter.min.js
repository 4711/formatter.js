/*!
 * v0.0.1
 * Copyright (c) 2013 First Opinion
 * formatter.js is open sourced under the MIT license.
 *
 * thanks to digitalBush/jquery.maskedinput for some of the trickier
 * keycode handling
 */
!function(){function a(a,c){var d=this;if(d.el=a,!d.el)throw new TypeError("Must provide an existing element");if(d.opts=utils.extend({},b,c),"undefined"==typeof d.opts.pattern)throw new TypeError("Must provide a pattern");var e=pattern.parse(d.opts.pattern);d.mLength=e.mLength,d.chars=e.chars,d.inpts=e.inpts,d.hldrs={},d.focus=0,utils.addListener(d.el,"keydown",function(a){d._keyDown(a)}),utils.addListener(d.el,"keypress",function(a){d._keyPress(a)}),utils.addListener(d.el,"paste",function(a){d._paste(a)}),d.opts.persistent&&(d._processKey(null,!0),d.el.blur(),utils.addListener(d.el,"focus",function(a){d._focus(a)}),utils.addListener(d.el,"click",function(a){d._focus(a)}),utils.addListener(d.el,"touchstart",function(a){d._focus(a)}))}"undefined"!=typeof window&&(window.Formatter=a);var b={persistent:!1,repeat:!1,placeholder:" "},c={9:new RegExp("[0-9]"),a:new RegExp("[A-Za-z]"),"*":new RegExp("[A-Za-z0-9]")};a.prototype._keyDown=function(a){var b=a.which||a.keyCode;return b&&utils.isDelKey(b)?(this._processKey(null,!0),utils.preventDefault(a)):void 0},a.prototype._keyPress=function(a){var b=a.which||a.keyCode;return utils.isDelKey(b)||utils.isModifier(a)?void 0:(this._processKey(String.fromCharCode(b),!1),utils.preventDefault(a))},a.prototype._paste=function(a){return this._processKey(utils.getClip(a),!1),utils.preventDefault(a)},a.prototype._focus=function(){var a=this;setTimeout(function(){var b=inptSel.get(a.el),c=b.end>a.focus;isFirstChar=0===b.end,(c||isFirstChar)&&inptSel.set(a.el,a.focus)},0)},a.prototype._processKey=function(a,b){this.sel=inptSel.get(this.el),this.val=this.el.value,this.delta=0,this.sel.begin!==this.sel.end?(this.delta=-1*Math.abs(this.sel.begin-this.sel.end),this.val=utils.removeChars(this.val,this.sel.begin,this.sel.end)):b&&this.sel.begin-1>=0&&(this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end),this.delta=-1),b||(this.val=utils.addChars(this.val,a,this.sel.begin),this.delta+=a.length),this._formatValue()},a.prototype._formatValue=function(){this.curPos=this.sel.end,this.newPos=this.curPos+this.delta,this._removeChars(),this._validateInpts(),this._addChars(),this.el.value=this.val.substr(0,this.mLength),inptSel.set(this.el,this.newPos)},a.prototype._removeChars=function(){this.sel.end>this.focus&&(this.delta+=this.sel.end-this.focus);for(var a=0,b=0;b<=this.mLength;b++){var c,d=this.chars[b],e=this.hldrs[b],f=b+a;f=b>=this.sel.begin?f+this.delta:f,c=this.val[f],(d&&d==c||e&&e==c)&&(this.val=utils.removeChars(this.val,f,f+1),a--)}this.hldrs={},this.focus=this.val.length},a.prototype._validateInpts=function(){for(var a=0;a<this.val.length;a++){var b=this.inpts[a];c[b]&&c[b].test(this.val[a])||(this.val=utils.removeChars(this.val,a,a+1),this.focusStart--,this.newPos--,this.delta--,a--)}},a.prototype._addChars=function(){if(this.opts.persistent){for(var a=0;a<=this.mLength;a++)this.val[a]||(this.val=utils.addChars(this.val,this.opts.placeholder,a),this.hldrs[a]=this.opts.placeholder),this._addChar(a);for(;this.chars[this.focus];)this.focus++}else for(var b=0;b<=this.val.length;b++)this._addChar(b)},a.prototype._addChar=function(a){var b=this.chars[a];return b?(utils.isBetween(a,[this.sel.begin-1,this.newPos+1])&&(this.newPos++,this.delta++),a<=this.focus&&this.focus++,this.delta<0&&this.val[a]==b?!0:(this.hldrs[a]&&(delete this.hldrs[a],this.hldrs[a+1]=this.opts.placeholder),this.val=utils.addChars(this.val,b,a),void 0)):!0},module.exports=pattern={};var d=4,e=new RegExp("{{([^}]+)}}","g"),f=function(a){for(var b,c=[];b=e.exec(a);)c.push(b);return c};pattern.parse=function(a){var b={inpts:{},chars:{}},c=f(a),e=a.length,g=0,h=0,i=0,j=function(a){for(var c=a.length,e=0;c>e;e++)b.inpts[h]=a[e],h++;g++,i+=a.length+d-1};for(i;e>i;i++)i==c[g].index?j(c[g][1]):b.chars[i-g*d]=a[i];return b.mLength=i-g*d,b},module.exports=inptSel={},inptSel.get=function(a){if("number"==typeof a.selectionStart)return{begin:a.selectionStart,end:a.selectionEnd};var b=document.selection.createRange();if(b&&b.parentElement()==a){var c=a.createTextRange(),d=a.createTextRange(),e=a.value.length;return c.moveToBookmark(b.getBookmark()),d.collapse(!1),c.compareEndPoints("StartToEnd",d)>-1?{begin:e,end:e}:{begin:-c.moveStart("character",-e),end:-c.moveEnd("character",-e)}}return{begin:0,end:0}},inptSel.set=function(a,b){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}},module.exports=utils={};var g="undefined"!=typeof navigator?navigator.userAgent:null,h=/iphone/i.test(g);utils.extend=function(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])a[c]=arguments[b][c];return a},utils.addChars=function(a,b,c){return a.substr(0,c)+b+a.substr(c,a.length)},utils.removeChars=function(a,b,c){return a.substr(0,b)+a.substr(c,a.length)},utils.isBetween=function(a,b){return b.sort(function(a,b){return a-b}),a>b[0]&&a<b[1]},utils.addListener=function(a,b,c){return"undefined"!=typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},utils.preventDefault=function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1},utils.getClip=function(a){return a.clipboardData?a.clipboardData.getData("Text"):window.clipboardData?window.clipboardData.getData("Text"):void 0},utils.isDelKey=function(a){return 8===a||46===a||h&&127===a},utils.isModifier=function(a){return a.ctrlKey||a.altKey||a.metaKey}}();